name: "Jitbit: Blue-Green Deployment"
on:
  workflow_dispatch:
    inputs:
        environment:
          required: true
          type: choice
          options:
            - "development"
            - "test"
            - "preproduction"
            - "production"
        image_tag:
            required: false
            type: string
            default: "latest"
        terraform_version:
            required: false
            type: string
            default: "~1.6"

jobs:
  create-container-plan:
    name: Plan for new container in delius-jitbit ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/modernisation-platform-oidc-cicd"
          role-session-name: "hmpps-delius-operational-automation-${{ github.run_number }}"
          aws-region: "eu-west-2"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "${{ inputs.terraform_version }}"
          terraform_wrapper: false

      - name: Terraform Init
        working-directory: terraform
        run: |
          terraform --version
          echo "terraform init -backend-config=environments/${{ inputs.environment }}/backend.hcl"
          terraform init -backend-config=environments/${{ inputs.environment }}/backend.hcl

      - name: Terraform Plan # ensures both blue and green are now running
        id: plan
        working-directory: terraform
        run: |
          set -o pipefail
          exitcode=0
          tfargs="-detailed-exitcode"
          echo "terraform plan -var-file=environments/${{ inputs.environment }}/terraform.tfvars -var="image_tag=${{ inputs.image_tag }}" -var="ecs_switch=true" $tfargs | tee tfplan.txt || exitcode=$?"
          terraform plan -var-file=environments/${{ inputs.environment }}/terraform.tfvars -var="image_tag=${{ inputs.image_tag }}" -var="ecs_switch=true" $tfargs | tee tfplan.txt || exitcode=$?
          echo "exitcode=${exitcode}"  # 0=clean plan, 1=error, 2=stuff in plan
          echo "exitcode=${exitcode}" >> $GITHUB_OUTPUT
          (( exitcode == 1 )) && exit 1 || exit 0

  create-container-apply:
    name: Apply for new container
    runs-on: ubuntu-latest
    needs: create-container-plan
    permissions:
      id-token: write
      contents: read
    environment: ${{ inputs.environment }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/modernisation-platform-oidc-cicd"
          role-session-name: "hmpps-delius-operational-automation-${{ github.run_number }}"
          aws-region: "eu-west-2"

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "${{ inputs.terraform_version }}"
          terraform_wrapper: false

      - name: Apply
        id: apply
        run: |
          set -e
          cd terraform
          terraform init -backend-config=environments/${{ inputs.environment }}/backend.hcl
          terraform apply -auto-approve -var-file=environments/${{ inputs.environment }}/terraform.tfvars -var="image_tag=${{ inputs.image_tag }}" -var="ecs_switch=true"

  manual-testing: #Â jitbit team checks their upgrade work at this point
    name: Wait for manual testing from jitbit team
    needs: create-container-apply
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Wait for approval
        run: echo "Waiting for approval" # change this

  # health-check:
  #   name: Automated health check
  #   needs: manual-testing
  #   runs-on: ubuntu-latest
  #   permissions:
  #     id-token: write
  #   environment: ${{ github.event.inputs.environment }}
  #   steps:
  #     - name: Configure AWS Credentials
  #       uses: aws-actions/configure-aws-credentials@v4
  #       with:
  #         role-to-assume: "arn:aws:iam::${{ vars.AWS_ACCOUNT_ID }}:role/modernisation-platform-oidc-cicd"
  #         role-session-name: "hmpps-delius-operational-automation-${{ github.run_number }}"
  #         aws-region: "eu-west-2"

  #     - name: Run health check
  #       run: |
  #         set -e

  #         BLUE_GREEN=$(aws ssm get-parameter --name "/blue_green" --query "Parameter.Value" --output text)

  #         # check prep cluster not current
  #         if [ "$BLUE_GREEN" == "blue" ]; then
  #           CLUSTER_NAME="hmpps-${{ github.event.inputs.environment }}-delius-jitbit-green"
  #         elif [ "$BLUE_GREEN" == "green" ]; then
  #           CLUSTER_NAME="hmpps-${{ github.event.inputs.environment }}-delius-jitbit-blue"
  #         fi

  #         echo "Fetching running tasks in cluster: $CLUSTER_NAME"
  #         TASK_ARNS=$(aws ecs list-tasks --cluster "$CLUSTER_NAME" --query "taskArns" --output text)

  #         if [ -z "$TASK_ARNS" ]; then
  #           echo "No running tasks found in cluster $CLUSTER_NAME"
  #           exit 1
  #         fi

  #         for TASK_ARN in $TASK_ARNS; do
  #           echo "Checking health for task: $TASK_ARN"
  #           HEALTH_STATUS=$(aws ecs describe-tasks --cluster "$CLUSTER_NAME" --tasks "$TASK_ARN" --query "tasks[*].healthStatus" --output text)

  #           if [ "$HEALTH_STATUS" != "HEALTHY" ]; then
  #             echo "Task $TASK_ARN is not healthy!"
  #             exit 1
  #           fi

  #           echo "Task $TASK_ARN is healthy."
  #         done

  #         echo "All tasks are healthy."

  switch-traffic:
    name: Switch traffic to new deployment
    # needs: health-check
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Get current target group
        id: get-tg
        run: |
          LISTENER_RULE_ARN=$(aws elbv2 describe-rules --query "Rules[?Tags[?Key=='Name' && Value=='blue-green']].RuleArn" --output text)
          CURRENT_TG=$(aws elbv2 describe-rules --rule-arns "$LISTENER_RULE_ARN" --query "Rules[0].Actions[0].TargetGroupArn" --output text)

          if [[ "$CURRENT_TG" == *"delius-jitbit-blue"* ]]; then
            NEW_TG="delius-jitbit-green"
          else
            NEW_TG="delius-jitbit-blue"
          fi

          echo "LISTENER_RULE_ARN=$LISTENER_RULE_ARN" >> $GITHUB_ENV
          echo "CURRENT_TG=$CURRENT_TG" >> $GITHUB_ENV
          echo "NEW_TG=$NEW_TG" >> $GITHUB_ENV

      - name: Switch target group
        run: |
          aws elbv2 modify-rule --rule-arn "$LISTENER_RULE_ARN" --actions Type=forward,TargetGroupArn=arn:aws:elasticloadbalancing:eu-west-2:${{ vars.AWS_ACCOUNT_ID }}:targetgroup/$NEW_TG

      - name: Update SSM parameter
        run: |
          BLUE_GREEN=$(aws ssm get-parameter --name "/blue_green" --query "Parameter.Value" --output text)

          if [ "$BLUE_GREEN" == "blue" ]; then
            CLUSTER_NAME="hmpps-${{ github.event.inputs.environment }}-delius-jitbit-green"
            NEW_BLUE_GREEN="green"
          elif [ "$BLUE_GREEN" == "green" ]; then
            CLUSTER_NAME="hmpps-${{ github.event.inputs.environment }}-delius-jitbit-blue"
            NEW_BLUE_GREEN="blue"
          fi

          aws ssm put-parameter --name "/blue_green" --value "$NEW_BLUE_GREEN" --type "String" --overwrite

  terminate-old: # need to depend on approval
    name: Terminate old container
    needs: switch-traffic
    runs-on: ubuntu-latest
    continue-on-error: true
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Terminate old container
        run: echo "Terminating old container instance..."

  rollback: # need to depend on approval
    name: Rollback to previous deployment
    needs: switch-traffic
    runs-on: ubuntu-latest
    continue-on-error: true
    environment: ${{ github.event.inputs.environment }}
    steps:
      - name: Switch traffic back to previous deployment
        run: echo "Switching traffic to previous deployment..."
      - name: Verify rollback success
        run: echo "Confirming rollback has been completed..."
